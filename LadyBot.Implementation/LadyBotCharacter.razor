@namespace LadyBot.Implementation
@using LadyBot.Program
@inject LadyBotMap Map

<g transform="translate(@this.aX, @this.aY)">
    @if (this.aAnimation is LadyBotAnimation.Translation translateTransform)
    {
        <animateTransform attributeName="transform"
                          dur="1s"
                          type="translate"
                          from="@(this.aX) @(this.aY)"
                          to="@translateTransform.NewX @translateTransform.NewY"
                          repeatCount="1"
                          id="anim"
                          fill="freeze" />
        <AnimationBeginElement Id="anim" />
    }
    <g transform="rotate(@this.aRotation, 0.5, 0.5)">
        @if (this.aAnimation is LadyBotAnimation.Rotation rotateTransform)
        {
            <animateTransform attributeName="transform"
                              dur="1s"
                              type="rotate"
                              from="@(this.aRotation) 0.5 0.5"
                              to="@rotateTransform.NewRotation 0.5 0.5"
                              repeatCount="1"
                              id="anim"
                              fill="freeze" />
            <AnimationBeginElement Id="anim" />
        }
        <path style="fill: black;"
              d="m 0.50049637,0.05025 a 0.45117886,0.45117886 0 0 0 -0.38705,0.22035 l -0.04296,-0.0182 c -7.51e-4,-3.2e-4 -0.0016,3e-5 -0.0019,7.8e-4 l -0.005,0.0118 c -3.17e-4,7.5e-4 3.2e-5,0.002 7.83e-4,0.002 l 0.04076,0.0172 a 0.45117886,0.45117886 0 0 0 -0.05418,0.18459 l -0.04906,-0.002 c -8.14e-4,-2e-5 -0.001499995,6.2e-4 -0.001499995,0.001 L 1.374575e-6,0.48057 c -2.5e-5,8.1e-4 6.15000005e-4,0.001 0.00139999543,0.002 l 0.04875,0.001 a 0.45117886,0.45117886 0 0 0 -8.51e-4,0.017 0.45117886,0.45117886 0 0 0 0.04094,0.18645 l -0.03289,0.0376 c -5.36e-4,6.2e-4 -4.76e-4,0.002 1.37e-4,0.002 l 0.0096,0.008 c 6.14e-4,5.4e-4 0.0015,4.8e-4 0.0021,-1.3e-4 l 0.02812,-0.0322 a 0.45117886,0.45117886 0 0 0 0.403175,0.24894 0.45117886,0.45117886 0 0 0 0.418874,-0.28457 l 0.04241,0.0249 c 7.03e-4,4.1e-4 0.0016,1.8e-4 0.002,-5.3e-4 l 0.0065,-0.011 c 4.12e-4,-7e-4 1.78e-4,-0.002 -5.26e-4,-0.002 l -0.04325,-0.0254 c -7.04e-4,-4.1e-4 -0.0016,-1.8e-4 -0.002,5.2e-4 l -4.41e-4,7.6e-4 a 0.45117886,0.45117886 0 0 0 0.02763,-0.15383 0.45117886,0.45117886 0 0 0 -0.0026,-0.0443 c 3.59e-4,4.1e-4 9.26e-4,6.1e-4 0.0015,4.6e-4 l 0.04837,-0.0132 c 7.86e-4,-2.2e-4 0.0012,-0.001 0.001,-0.002 l -0.0034,-0.0123 c -2.15e-4,-7.9e-4 -0.001,-0.001 -0.0018,-0.001 l -0.04752,0.013 a 0.45117886,0.45117886 0 0 0 -0.0578,-0.16839 c 1.03e-4,-4e-5 2.13e-4,-5e-5 3.12e-4,-1.2e-4 l 0.04245,-0.0267 c 6.9e-4,-4.3e-4 8.98e-4,-0.001 4.64e-4,-0.002 l -0.0068,-0.0108 c -4.34e-4,-6.9e-4 -0.0013,-9e-4 -0.002,-4.7e-4 l -0.04219,0.0265 a 0.45117886,0.45117886 0 0 0 -0.381136,-0.20999 z" />
        <path style="fill: white;"
              d="m 0.38302037,0.12466 a 0.04045566,0.04045566 0 0 0 -0.04045,0.0405 0.04045566,0.04045566 0 0 0 0.04045,0.0404 0.04045566,0.04045566 0 0 0 0.04046,-0.0404 0.04045566,0.04045566 0 0 0 -0.04046,-0.0405 z m -0.01108,0.0167 c 0.0081,0 0.01472,0.007 0.01472,0.0147 0,0.008 -0.0067,0.0147 -0.01472,0.0147 -0.0081,0 -0.01471,-0.007 -0.01471,-0.0147 0,-0.008 0.0066,-0.0147 0.01471,-0.0147 z m 0,0.0103 c -0.0025,0 -0.0044,0.002 -0.0044,0.004 0,0.002 0.0019,0.004 0.0044,0.004 0.0025,0 0.0044,-0.002 0.0044,-0.004 0,-0.002 -0.0019,-0.004 -0.0044,-0.004 z" />
        <path style="fill: white;"
              d="m 0.63269137,0.11287 a 0.04045566,0.04045566 0 0 0 -0.04045,0.0404 0.04045566,0.04045566 0 0 0 0.04045,0.0405 0.04045566,0.04045566 0 0 0 0.04046,-0.0405 0.04045566,0.04045566 0 0 0 -0.04046,-0.0404 z m -0.01108,0.0167 c 0.0081,0 0.01471,0.007 0.01471,0.0147 0,0.008 -0.0066,0.0147 -0.01471,0.0147 -0.0081,0 -0.01471,-0.007 -0.01471,-0.0147 0,-0.008 0.0066,-0.0147 0.01471,-0.0147 z m 0,0.0103 c -0.0025,0 -0.0044,0.002 -0.0044,0.004 0,0.002 0.0019,0.004 0.0044,0.004 0.0025,0 0.0044,-0.002 0.0044,-0.004 0,-0.002 -0.0019,-0.004 -0.0044,-0.004 z" />
        <path style="fill: red;"
              d="m 0.17949437,0.22573 a 0.41781346,0.41781346 0 0 0 -0.103481,0.27446 0.41781346,0.41781346 0 0 0 0.285173,0.39521 l 0.109251,-0.13052 V 0.28073 a 0.54422399,0.30026508 0 0 1 -0.290943,-0.055 z m 0.05916,0.0945 a 0.05004418,0.05004418 0 0 1 0.05004,0.05 0.05004418,0.05004418 0 0 1 -0.05004,0.05 0.05004418,0.05004418 0 0 1 -0.05004,-0.05 0.05004418,0.05004418 0 0 1 0.05004,-0.05 z m 0.130674,0.18211 a 0.05004418,0.05004418 0 0 1 0.05004,0.05 0.05004418,0.05004418 0 0 1 -0.05004,0.05 0.05004418,0.05004418 0 0 1 -0.05004,-0.05 0.05004418,0.05004418 0 0 1 0.05004,-0.05 z m -0.109821,0.17515 a 0.05004418,0.05004418 0 0 1 0.05004,0.05 0.05004418,0.05004418 0 0 1 -0.05004,0.05 0.05004418,0.05004418 0 0 1 -0.05005,-0.05 0.05004418,0.05004418 0 0 1 0.05005,-0.05 z" />
        <path style="fill: red;"
              d="m 0.81457437,0.22573 a 0.54422399,0.30026508 0 0 1 -0.290944,0.055 v 0.48415 l 0.109251,0.13052 a 0.41781346,0.41781346 0 0 0 0.285174,-0.39521 0.41781346,0.41781346 0 0 0 -0.103481,-0.27446 z m -0.03794,0.0917 a 0.05004418,0.05004418 0 0 1 0.05004,0.05 0.05004418,0.05004418 0 0 1 -0.05004,0.05 0.05004418,0.05004418 0 0 1 -0.05004,-0.05 0.05004418,0.05004418 0 0 1 0.05004,-0.05 z m -0.126501,0.18767 a 0.05004418,0.05004418 0 0 1 0.05005,0.05 0.05004418,0.05004418 0 0 1 -0.05005,0.05 0.05004418,0.05004418 0 0 1 -0.05005,-0.05 0.05004418,0.05004418 0 0 1 0.05005,-0.05 z m 0.102866,0.16542 a 0.05004418,0.05004418 0 0 1 0.05004,0.05 0.05004418,0.05004418 0 0 1 -0.05004,0.05 0.05004418,0.05004418 0 0 1 -0.05004,-0.05 0.05004418,0.05004418 0 0 1 0.05004,-0.05 z" />
    </g>
</g>

@code
{
    private int aX;
    private int aY;
    private int aRotation;

    private LadyBotAnimation aAnimation;

    public void Reset()
    {
        this.aX = this.Map.InitialX;
        this.aY = this.Map.InitialY;
        this.aRotation = this.Map.InitialRotation;

        this.StateHasChanged();
    }

    public async Task MoveForward()
    {
        switch (this.aRotation)
        {
            case Rotation.Up:
                await this.MoveInDirection(0, -1);
                break;
            case Rotation.Right:
                await this.MoveInDirection(1, 0);
                break;
            case Rotation.Down:
                await this.MoveInDirection(0, 1);
                break;
            case Rotation.Left:
                await this.MoveInDirection(-1, 0);
                break;
            default:
                throw new ArgumentOutOfRangeException();
        }

        this.StateHasChanged();
    }

    private async Task MoveInDirection(int dx, int dy)
    {
        if (this.aX + dx < 0 || this.aX + dx >= this.Map.Width || this.aY + dy < 0 || this.aY + dy >= this.Map.Height)
            throw new BumpedException();

        await this.DoAnimation(new LadyBotAnimation.Translation(this.aX + dx, this.aY + dy));
        this.aX += dx;
        this.aY += dy;
    }

    public async Task Rotate(int newRotation)
    {
        if (newRotation == this.aRotation)
            return;

        newRotation = (newRotation + 360) % 360;

        await this.DoAnimation(new LadyBotAnimation.Rotation(this.aRotation, newRotation));
        this.aRotation = newRotation;

        this.StateHasChanged();
    }

    public async Task RotateRight()
    {
        await this.Rotate(this.aRotation + 90);
    }

    public async Task RotateLeft()
    {
        await this.Rotate(this.aRotation - 90);
    }

    #region Overrides of ComponentBase

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        this.Reset();
    }

    #endregion

    private async Task DoAnimation(LadyBotAnimation animation)
    {
        this.aAnimation = animation;

        this.StateHasChanged();
        await Task.Delay(1100);

        this.aAnimation = null;
    }
}
